<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inventaire StockApp</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #4B0082; }
    #items { margin-top: 20px; }
    .item { padding: 8px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .info { flex-grow: 1; }
    input { margin: 5px; padding: 6px; }
    button { margin: 5px; padding: 6px 10px; }
    #editForm { margin-top: 10px; padding: 10px; border: 1px dashed #ccc; }
    .controls { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
    .muted { color: #666; font-size: 12px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4B0082">
</head>
<body>
  <h1>Inventaire</h1>

  <div class="controls">
    <input id="name" placeholder="Nom de l'article">
    <input id="supplier" placeholder="Fournisseur">
    <input id="price" type="number" step="0.01" placeholder="Prix (‚Ç¨)">
    <input id="quantity" type="number" placeholder="Quantit√©">
    <button onclick="addCustomItem()">‚ûï Ajouter</button>
    <input id="search" placeholder="Rechercher (nom ou fournisseur)‚Ä¶">
    <span class="muted" id="countInfo"></span>
    <input id="code" placeholder="Code QR ou identifiant">
  </div>

  <h2>Articles en stock</h2>
  <div id="items"></div>
  <div id="editForm"></div>
<button onclick="exportPDF()">üìÑ Exporter en PDF</button>
<button onclick="startScanner()">üì∑ Scanner un code</button>
<div id="reader" style="width:300px; margin-top:10px;"></div>
  <script>
  let items = [];
  let currentFilter = '';
const API_URL = "https://stockapp-backend-w2fn.onrender.com";
  function normalize(str) {
    return (str || '')
      .toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .trim();
  }

  function renderItems(list = items) {
    const container = document.getElementById('items');
    container.innerHTML = '';
    document.getElementById('countInfo').textContent = `(${list.length} affich√©(s) / ${items.length} total)`;

    if (list.length === 0) {
      container.innerHTML = '<p>Aucun article en stock</p>';
    } else {
      list.forEach(item => {
        container.innerHTML += `
          <div class="item">
            <div class="info">
              <strong>${item.name}</strong> ‚Äî Fournisseur: ${item.supplier}<br>
              Prix: ${Number(item.price).toFixed(2)} ‚Ç¨ ‚Ä¢ Stock: ${item.quantity}
            </div>
            <div>
              <button onclick="editItem(${item.id})">‚úèÔ∏è Modifier</button>
              <button onclick="deleteItem(${item.id})">üóëÔ∏è Supprimer</button>
            </div>
          </div>`;
      });
    }
  }

  function applyFilter() {
    const q = normalize(currentFilter);
    if (!q) {
      renderItems(items);
      return;
    }
    const filtered = items.filter(i =>
      normalize(i.name).includes(q) ||
      normalize(i.supplier).includes(q)
    );
    renderItems(filtered);
  }

  // ‚úÖ Ajout via API
 async function addCustomItem() {
  const newItem = {
    name: document.getElementById('name').value || 'Article',
    supplier: document.getElementById('supplier').value || 'Inconnu',
    price: parseFloat(document.getElementById('price').value) || 0,
    quantity: parseInt(document.getElementById('quantity').value) || 0,
    code: document.getElementById('code').value || ''
  };

  console.log("‚û°Ô∏è POST /items payload:", newItem);

  try {
    const res = await fetch(`${API_URL}/items`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newItem)
    });

    console.log("‚¨ÖÔ∏è Response status:", res.status);

    if (!res.ok) {
      const text = await res.text().catch(() => "(no body)");
      console.error("‚ùå POST /items failed:", res.status, text);
      alert(`Ajout impossible (HTTP ${res.status}). V√©rifie la console.`);
      return; // ne pas vider les champs si √©chec
    }

    const data = await res.json().catch(() => ({}));
    console.log("‚úÖ Ajout OK:", data);

    // vider les champs uniquement si succ√®s
    document.getElementById('name').value = '';
    document.getElementById('supplier').value = '';
    document.getElementById('price').value = '';
    document.getElementById('quantity').value = '';
    document.getElementById('code').value = '';

    await loadItems();
  } catch (err) {
    console.error("üî• Exception POST /items:", err);
    alert("Erreur r√©seau lors de l'ajout. Regarde la console.");
    // ne pas vider les champs si erreur
  }
}

  // ‚úÖ Suppression via API
  async function deleteItem(id) {
    await fetch(`${API_URL}/items/${id}`, { method: "DELETE" });
    await loadItems();
    const editForm = document.getElementById('editForm');
    if (editForm.dataset.editingId == id) {
      editForm.innerHTML = '';
      editForm.dataset.editingId = '';
    }
    applyFilter();
  }

  function editItem(id) {
    const item = items.find(i => i.id === id);
    const editForm = document.getElementById('editForm');
    editForm.dataset.editingId = id;
    editForm.innerHTML = `
      <h3>Modifier l'article</h3>
      <input id="editName" placeholder="Nom" value="${item.name}">
      <input id="editSupplier" placeholder="Fournisseur" value="${item.supplier}">
      <input id="editPrice" type="number" step="0.01" placeholder="Prix (‚Ç¨)" value="${item.price}">
      <input id="editQuantity" type="number" placeholder="Quantit√©" value="${item.quantity}">
      <input id="editCode" placeholder="Code QR ou identifiant" value="${item.code || ''}">
      <button onclick="saveEdit(${id})">‚úÖ Sauvegarder</button>
      <button onclick="cancelEdit()">‚ùå Annuler</button>
    `;
  }

  async function saveEdit(id) {
    const updated = {
      name: document.getElementById('editName').value,
      supplier: document.getElementById('editSupplier').value,
      price: parseFloat(document.getElementById('editPrice').value) || 0,
      quantity: parseInt(document.getElementById('editQuantity').value) || 0,
      code: document.getElementById('editCode').value || ''
    };

    await fetch(`${API_URL}/items/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updated)
    });

    await loadItems();
    cancelEdit();
    applyFilter();
  }

  function cancelEdit() {
    const editForm = document.getElementById('editForm');
    editForm.innerHTML = '';
    editForm.dataset.editingId = '';
  }

  // ‚úÖ Chargement initial
  async function loadItems() {
      try {
    console.log("‚û°Ô∏è GET /items");
    const res = await fetch(`${API_URL}/items`);
    console.log("‚¨ÖÔ∏è GET status:", res.status);
    if (!res.ok) {
      const text = await res.text().catch(() => "(no body)");
      console.error("‚ùå GET /items failed:", res.status, text);
      alert(`Chargement impossible (HTTP ${res.status}).`);
      return;
    }
    items = await res.json();
    applyFilter();
  } catch (err) {
    console.error("üî• Exception GET /items:", err);
    alert("Erreur r√©seau lors du chargement des articles.");
  }


    const res = await fetch(`${API_URL}/items`);
    items = await res.json();
    applyFilter();
  }
  function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Inventaire StockApp", 10, 10);

  let y = 20;
  items.forEach(item => {
    doc.setFontSize(12);
    doc.text(
      `${item.name} ‚Äî Fournisseur: ${item.supplier} | Prix: ${Number(item.price).toFixed(2)} ‚Ç¨ | Stock: ${item.quantity}`,
      10,
      y
    );
    y += 10;
  });

  doc.save("inventaire.pdf");
}
function startScanner() {
  const qrReader = new Html5Qrcode("reader");

  qrReader.start(
    { facingMode: "environment" }, // cam√©ra arri√®re sur mobile
    {
      fps: 10,
      qrbox: 250
    },
    qrCodeMessage => {
      console.log("‚úÖ Code scann√© :", qrCodeMessage);
      // Remplir automatiquement le champ "code"
      document.getElementById("code").value = qrCodeMessage;
      // Arr√™ter le scanner apr√®s lecture
      qrReader.stop().then(() => {
        console.log("Scanner arr√™t√©");
      }).catch(err => console.error("Erreur arr√™t scanner:", err));
    },
    errorMessage => {
      // erreurs silencieuses (ex: pas de QR d√©tect√©)
    }
  ).catch(err => {
    console.error("‚ùå Erreur scanner :", err);
  });
}
  // Recherche dynamique
  document.getElementById('search').addEventListener('input', (e) => {
    currentFilter = e.target.value;
    applyFilter();
  });

  // Charger au d√©marrage
  loadItems();

  // Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log("Service Worker enregistr√©"))
      .catch(err => console.error("Erreur SW:", err));
  }
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  const btn = document.createElement('button');
  btn.textContent = "üì≤ Installer StockApp";
  btn.style = "position:fixed;bottom:20px;left:20px;padding:10px;background:#4B0082;color:white;border:none;border-radius:5px;z-index:1000;";
  btn.onclick = () => {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(choice => {
      if (choice.outcome === 'accepted') {
        console.log("‚úÖ Installation accept√©e");
      } else {
        console.log("‚ùå Installation refus√©e");
      }
      deferredPrompt = null;
      btn.remove();
    });
  };
  document.body.appendChild(btn);
});

fetch('manifest.json')
  .then(r => console.log("Manifest status:", r.status));

  </script>
</body>
</html>