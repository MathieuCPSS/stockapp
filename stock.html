<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inventaire StockApp</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #4B0082; }
    #items { margin-top: 20px; }
    .item { padding: 8px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .info { flex-grow: 1; }
    input { margin: 5px; padding: 6px; }
    button { margin: 5px; padding: 6px 10px; }
    #editForm { margin-top: 10px; padding: 10px; border: 1px dashed #ccc; }
    .controls { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
    .muted { color: #666; font-size: 12px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h1>Inventaire</h1>

  <div class="controls">
    <input id="name" placeholder="Nom de l'article">
    <input id="supplier" placeholder="Fournisseur">
    <input id="price" type="number" step="0.01" placeholder="Prix (‚Ç¨)">
    <input id="quantity" type="number" placeholder="Quantit√©">
    <input id="code" placeholder="Code QR ou identifiant">
    <button onclick="addCustomItem()">‚ûï Ajouter</button>
    <div id="reader" style="width:300px; margin-top:10px;"></div>
    <button onclick="startScanner()">üì∑ Scanner un code</button>
    <input id="search" placeholder="Rechercher (nom ou fournisseur)‚Ä¶">
    <span class="muted" id="countInfo"></span>
  </div>

  <h2>Articles en stock</h2>
  <div id="items"></div>
  <div id="editForm"></div>
<button onclick="exportPDF()">üìÑ Exporter en PDF</button>
  <button onclick="saveBackupHTML()">üíæ Sauvegarder en HTML</button>
  <script>
    let items = [];
    let currentFilter = ''; // garde la requ√™te de recherche courante

    // Utilitaire: normalise pour recherche (sans accents, en minuscule)
    function normalize(str) {
      return (str || '')
        .toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .trim();
    }

    function renderItems(list = items) {
      const container = document.getElementById('items');
      container.innerHTML = '';
      document.getElementById('countInfo').textContent = `(${list.length} affich√©(s) / ${items.length} total)`;

      if (list.length === 0) {
        container.innerHTML = '<p>Aucun article en stock</p>';
      } else {
        list.forEach(item => {
          container.innerHTML += `
            <div class="item">
              <div class="info">
                <strong>${item.name}</strong> ‚Äî Fournisseur: ${item.supplier}<br>
                Prix: ${Number(item.price).toFixed(2)} ‚Ç¨ ‚Ä¢ Stock: ${item.quantity}
              </div>
              <div>
                <button onclick="editItem(${item.id})">‚úèÔ∏è Modifier</button>
                <button onclick="deleteItem(${item.id})">üóëÔ∏è Supprimer</button>
              </div>
            </div>`;
        });
      }
    }

    function applyFilter() {
      const q = normalize(currentFilter);
      if (!q) {
        renderItems(items);
        return;
      }
      const filtered = items.filter(i =>
        normalize(i.name).includes(q) ||
        normalize(i.supplier).includes(q)
      );
      renderItems(filtered);
    }

    function addCustomItem() {
      const newItem = {
        id: Date.now(),
        name: document.getElementById('name').value || 'Article',
        supplier: document.getElementById('supplier').value || 'Inconnu',
        price: parseFloat(document.getElementById('price').value) || 0,
        quantity: parseInt(document.getElementById('quantity').value) || 0
      };
      items.push(newItem);
      saveItems();
      // R√©initialiser le formulaire
      document.getElementById('name').value = '';
      document.getElementById('supplier').value = '';
      document.getElementById('price').value = '';
      document.getElementById('quantity').value = '';
      // R√©appliquer le filtre pour garder la vue coh√©rente
      applyFilter();
    }

    function deleteItem(id) {
      items = items.filter(item => item.id !== id);
      saveItems();
      // Fermer l'√©dition si elle concernait l'√©l√©ment supprim√©
      const editForm = document.getElementById('editForm');
      if (editForm.dataset.editingId == id) {
        editForm.innerHTML = '';
        editForm.dataset.editingId = '';
      }
      applyFilter();
    }

    function editItem(id) {
      const item = items.find(i => i.id === id);
      const editForm = document.getElementById('editForm');
      editForm.dataset.editingId = id;
      editForm.innerHTML = `
        <h3>Modifier l'article</h3>
        <input id="editName" placeholder="Nom" value="${item.name}">
        <input id="editSupplier" placeholder="Fournisseur" value="${item.supplier}">
        <input id="editPrice" type="number" step="0.01" placeholder="Prix (‚Ç¨)" value="${item.price}">
        <input id="editQuantity" type="number" placeholder="Quantit√©" value="${item.quantity}">
        <button onclick="saveEdit(${id})">‚úÖ Sauvegarder</button>
        <button onclick="cancelEdit()">‚ùå Annuler</button>
      `;
    }

    function saveEdit(id) {
      const item = items.find(i => i.id === id);
      item.name = document.getElementById('editName').value || item.name;
      item.supplier = document.getElementById('editSupplier').value || item.supplier;
      item.price = parseFloat(document.getElementById('editPrice').value) || 0;
      item.quantity = parseInt(document.getElementById('editQuantity').value) || 0;

      saveItems();
      cancelEdit(); // ferme le formulaire
      applyFilter(); // r√©applique la recherche courante
    }

    function cancelEdit() {
      const editForm = document.getElementById('editForm');
      editForm.innerHTML = '';
      editForm.dataset.editingId = '';
    }

    function saveItems() {
      localStorage.setItem('stockItems', JSON.stringify(items));
    }

    function loadItems() {
      const data = localStorage.getItem('stockItems');
      if (data) {
        items = JSON.parse(data);
      }
      applyFilter();
    }

   function startScanner() {
  const qrReader = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
      const backCam = devices.find(d => d.label && d.label.toLowerCase().includes("back")) || devices[0];

      qrReader.start(
        backCam.id,
        { fps: 10, qrbox: 300 },
        qrCodeMessage => {
          console.log("‚úÖ Code scann√© :", qrCodeMessage);

          const editForm = document.getElementById("editForm");

          if (editForm.dataset.editingId) {
            // üëâ Cas 1 : on √©dite un article existant
            document.getElementById("editCode").value = qrCodeMessage;
          } else if (
            document.getElementById("name").value ||
            document.getElementById("supplier").value ||
            document.getElementById("price").value ||
            document.getElementById("quantity").value
          ) {
            // üëâ Cas 2 : on est en train de cr√©er un nouvel article
            document.getElementById("code").value = qrCodeMessage;
          } else {
            // üëâ Cas 3 : aucun formulaire actif ‚Üí utiliser comme recherche
            document.getElementById("search").value = qrCodeMessage;
            currentFilter = qrCodeMessage;
            applyFilter();
          }

          qrReader.stop().then(() => {
            console.log("Scanner arr√™t√©");
          }).catch(err => console.error("Erreur arr√™t scanner:", err));
        },
        errorMessage => {
          // erreurs silencieuses
        }
      ).catch(err => console.error("‚ùå Erreur d√©marrage cam√©ra:", err));
    } else {
      alert("Aucune cam√©ra d√©tect√©e sur cet appareil.");
    }
  }).catch(err => console.error("Erreur d√©tection cam√©ras:", err));
}

      
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Inventaire StockApp", 10, 10);

  let y = 20;
  items.forEach(i => {
    doc.text(
      `${i.name} ‚Äî Fournisseur: ${i.supplier} | Prix: ${i.price.toFixed(2)} ‚Ç¨ | Stock: ${i.quantity}`,
      10,
      y
    );
    y += 10;
  });

  doc.save("inventaire.pdf");
}
    // Recherche dynamique: √©coute l'input et filtre en direct
    document.getElementById('search').addEventListener('input', (e) => {
      currentFilter = e.target.value;
      applyFilter();
    });

    // Charger au d√©marrage
    loadItems();

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

function saveBackupHTML() {
  const title = 'Inventaire StockApp - Backup';
  const timestamp = new Date().toLocaleString();

  const rows = items.map(i => `
    <li>
      <strong>${escapeHtml(i.name)}</strong> ‚Äî Fournisseur: ${escapeHtml(i.supplier)}<br>
      Code: ${escapeHtml(i.code || '')} ‚Ä¢ Prix: ${Number(i.price || 0).toFixed(2)} ‚Ç¨ ‚Ä¢ Stock: ${escapeHtml(i.quantity)}
    </li>`).join('\n');

  const html = `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>${title}</title>
</head>
<body>
  <h1>${title}</h1>
  <p>Sauvegarde g√©n√©r√©e le ${timestamp}</p>
  <ul>
    ${rows}
  </ul>
</body>
</html>`;

  const blob = new Blob([html], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "inventaire_backup.html";
  a.click();
  URL.revokeObjectURL(url);
}
    
  </script>
</body>
</html>
