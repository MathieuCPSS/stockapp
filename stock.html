<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inventaire StockApp</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #4B0082; }
    #items { margin-top: 20px; }
    .item { padding: 8px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .info { flex-grow: 1; }
    input { margin: 5px; padding: 6px; }
    button { margin: 5px; padding: 6px 10px; }
    #editForm { margin-top: 10px; padding: 10px; border: 1px dashed #ccc; }
    .controls { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
    .muted { color: #666; font-size: 12px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4B0082">
</head>
<body>
  <h1>Inventaire</h1>

  <div class="controls">
    <input id="name" placeholder="Nom de l'article">
    <input id="supplier" placeholder="Fournisseur">
    <input id="price" type="number" step="0.01" placeholder="Prix (‚Ç¨)">
    <input id="quantity" type="number" placeholder="Quantit√©">
    <button onclick="addCustomItem()">‚ûï Ajouter</button>
    <input id="search" placeholder="Rechercher (nom ou fournisseur)‚Ä¶">
    <span class="muted" id="countInfo"></span>
    <input id="code" placeholder="Code QR ou identifiant">
  </div>

  <h2>Articles en stock</h2>
  <div id="items"></div>
  <div id="editForm"></div>
<button onclick="exportPDF()">üìÑ Exporter en PDF</button>
<button onclick="startScanner()">üì∑ Scanner un code</button>
<div id="reader" style="width:300px; margin-top:10px;"></div>
  <script>
    let items = [];
    let currentFilter = ''; // garde la requ√™te de recherche courante

    // Utilitaire: normalise pour recherche (sans accents, en minuscule)
    function normalize(str) {
      return (str || '')
        .toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .trim();
    }

    function renderItems(list = items) {
      const container = document.getElementById('items');
      container.innerHTML = '';
      document.getElementById('countInfo').textContent = `(${list.length} affich√©(s) / ${items.length} total)`;

      if (list.length === 0) {
        container.innerHTML = '<p>Aucun article en stock</p>';
      } else {
        list.forEach(item => {
          container.innerHTML += `
            <div class="item">
              <div class="info">
                <strong>${item.name}</strong> ‚Äî Fournisseur: ${item.supplier}<br>
                Prix: ${Number(item.price).toFixed(2)} ‚Ç¨ ‚Ä¢ Stock: ${item.quantity}
              </div>
              <div>
                <button onclick="editItem(${item.id})">‚úèÔ∏è Modifier</button>
                <button onclick="deleteItem(${item.id})">üóëÔ∏è Supprimer</button>
              </div>
            </div>`;
        });
      }
    }

    function applyFilter() {
      const q = normalize(currentFilter);
      if (!q) {
        renderItems(items);
        return;
      }
      const filtered = items.filter(i =>
        normalize(i.name).includes(q) ||
        normalize(i.supplier).includes(q)
      );
      renderItems(filtered);
    }

    function addCustomItem() {
      const newItem = {
        id: Date.now(),
        name: document.getElementById('name').value || 'Article',
        supplier: document.getElementById('supplier').value || 'Inconnu',
        price: parseFloat(document.getElementById('price').value) || 0,
        quantity: parseInt(document.getElementById('quantity').value) || 0,
        code: document.getElementById('code').value || '' // ‚úÖ nouveau champ
      };
      items.push(newItem);
      saveItems();
      // R√©initialiser le formulaire
      document.getElementById('name').value = '';
      document.getElementById('supplier').value = '';
      document.getElementById('price').value = '';
      document.getElementById('quantity').value = '';
      document.getElementById('code').value = ''; // ‚úÖ reset du champ
      // R√©appliquer le filtre pour garder la vue coh√©rente
      applyFilter();
    }

 async function deleteItem(id) {
  // Appel √† l'API pour supprimer l'article
  await fetch(`http://localhost:3000/items/${id}`, {
    method: "DELETE"
  });

  // Recharge la liste depuis le serveur
  await loadItems();

  // Fermer l'√©dition si elle concernait l'√©l√©ment supprim√©
  const editForm = document.getElementById('editForm');
  if (editForm.dataset.editingId == id) {
    editForm.innerHTML = '';
    editForm.dataset.editingId = '';
  }

  applyFilter();
}

    function editItem(id) {
      const item = items.find(i => i.id === id);
      const editForm = document.getElementById('editForm');
      editForm.dataset.editingId = id;
      editForm.innerHTML = `
        <h3>Modifier l'article</h3>
        <input id="editName" placeholder="Nom" value="${item.name}">
        <input id="editSupplier" placeholder="Fournisseur" value="${item.supplier}">
        <input id="editPrice" type="number" step="0.01" placeholder="Prix (‚Ç¨)" value="${item.price}">
        <input id="editQuantity" type="number" placeholder="Quantit√©" value="${item.quantity}">
        <input id="editCode" placeholder="Code QR ou identifiant" value="${item.code || ''}"> <!-- ‚úÖ nouveau champ -->
        <button onclick="saveEdit(${id})">‚úÖ Sauvegarder</button>
        <button onclick="cancelEdit()">‚ùå Annuler</button>
              `;
    }

    // ‚úÖ Sauvegarder les modifications
  function saveEdit(id) {
    const updated = {
      name: document.getElementById('editName').value,
      supplier: document.getElementById('editSupplier').value,
      price: parseFloat(document.getElementById('editPrice').value) || 0,
      quantity: parseInt(document.getElementById('editQuantity').value) || 0,
      code: document.getElementById('editCode').value || ''
    };

    updateItem(id, updated);
  }

 // üîÑ Envoyer la mise √† jour √† l‚ÄôAPI
  async function updateItem(id, updated) {
    await fetch(`http://localhost:3000/items/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updated)
    });

    await loadItems();   // recharge la liste depuis le serveur
    cancelEdit();        // ferme le formulaire
    applyFilter();       // r√©applique la recherche courante
  }

  // ‚ùå Fermer le formulaire d‚Äô√©dition
  function cancelEdit() {
    const editForm = document.getElementById('editForm');
    editForm.innerHTML = '';
    editForm.dataset.editingId = '';
  }



    function cancelEdit() {
      const editForm = document.getElementById('editForm');
      editForm.innerHTML = '';
      editForm.dataset.editingId = '';
    }

  async function saveItems(newItem) {
  await fetch("http://localhost:3000/items", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(newItem)
  });
  loadItems(); // recharge la liste apr√®s ajout
}
async function loadItems() {
  const res = await fetch("http://localhost:3000/items");
  items = await res.json(); // r√©cup√®re tous les articles depuis la base
  applyFilter(); // garde ta logique de filtre
}
   
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Inventaire StockApp", 10, 10);

  let y = 20;
  items.forEach(i => {
    doc.text(
      `${i.name} ‚Äî Fournisseur: ${i.supplier} | Prix: ${i.price.toFixed(2)} ‚Ç¨ | Stock: ${i.quantity}`,
      10,
      y
    );
    y += 10;
  });

  doc.save("inventaire.pdf");
}
    // Recherche dynamique: √©coute l'input et filtre en direct
    document.getElementById('search').addEventListener('input', (e) => {
      currentFilter = e.target.value;
      applyFilter();
    });

    let qrScanner;
    let scannerActive = false;


function startScanner() {
  if (!qrScanner) {
    qrScanner = new Html5Qrcode("reader");
  }
  if (!scannerActive) {
    qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess
    ).then(() => {
      scannerActive = true;
    });
  }
}
function onScanSuccess(decodedText, decodedResult) {
  // Cherche d'abord si l'article existe d√©j√†
  const item = items.find(i =>
    i.id.toString() === decodedText ||
    i.name === decodedText ||
    i.supplier === decodedText ||
    i.code === decodedText
  );

  if (item) {
    // ‚úÖ Ouvre directement en mode modification
    editItem(item.id);
  } else {
    // Sinon, si on est en ajout/√©dition, remplir le champ code
    const codeField = document.getElementById('code') || document.getElementById('editCode');
    if (codeField) {
      codeField.value = decodedText;
      alert("Code QR li√© au nouvel article !");
    } else {
      alert("Article non trouv√© !");
    }
  }

  // ‚úÖ Arr√™t propre du scanner
  if (qrScanner && scannerActive) {
    qrScanner.stop()
      .then(() => {
        console.log("Scanner arr√™t√©");
        scannerActive = false;
      })
      .catch(err => console.error("Erreur lors de l'arr√™t du scanner:", err));
  }
}





function saveQuantity(id) {
  const item = items.find(i => i.id === id);
  item.quantity = parseInt(document.getElementById('editQuantity').value);
  saveItems();
  renderItems();
  cancelEdit();
}
    // Charger au d√©marrage
    loadItems();
// ‚úÖ Enregistrement du service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("Service Worker enregistr√©"))
        .catch(err => console.error("Erreur SW:", err));
    }
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  const btn = document.createElement('button');
  btn.textContent = "üì≤ Installer StockApp";
  btn.style = "position:fixed;bottom:20px;left:20px;padding:10px;background:#4B0082;color:white;border:none;border-radius:5px;z-index:1000;";
  btn.onclick = () => {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(choice => {
      if (choice.outcome === 'accepted') {
        console.log("‚úÖ Installation accept√©e");
      } else {
        console.log("‚ùå Installation refus√©e");
      }
      deferredPrompt = null;
      btn.remove();
    });
  };
  document.body.appendChild(btn);
});

fetch('manifest.json')
  .then(r => console.log("Manifest status:", r.status));

  </script>
</body>
</html>